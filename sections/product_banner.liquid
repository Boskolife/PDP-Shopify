{{- 'banner_product.css' | asset_url | stylesheet_tag -}}
{{- 'swiper.css' | asset_url | stylesheet_tag -}}
<script src="{{ 'swiper.js' | asset_url }}" defer></script>
<script src="{{ 'product-gallery.js' | asset_url }}" defer></script>

{%- liquid
  # 1. Отримуємо продукт (з параметра або handle)
  assign current_product = section.settings.product

  if current_product == blank and section.settings.product_handle != blank
    assign current_product = all_products[section.settings.product_handle]
  endif

  # Fallback: якщо продукт все ще не знайдено, беремо з контексту сторінки
  if current_product == blank
    if product
      assign current_product = product
      assign show_error = false
    else
      assign show_error = true
    endif
  else
    assign show_error = false
  endif

  # 2. Перевірка наявності даних
  assign has_price = false
  if current_product.price > 0
    assign has_price = true
  endif

  assign has_rating = false
  if current_product.metafields.custom.rating
    assign has_rating = true
  endif

  assign delivery_and_payment_tips = current_product.metafields.custom.delivery_and_payment_tips.value
  assign product_secondary_description = current_product.metafields.custom.secondary_description.value
  assign product_accordion_items = current_product.metafields.custom.accordions.value
-%}

{%- assign all_media_images = current_product.media | where: 'media_type', 'image' -%}
<script>
  window.PRODUCT_ALL_IMAGES = [
    {%- for m in all_media_images -%}
      {
        "title": {{ m.title | json }},
        "src": "{{ m | image_url: width: 1000 }}",
        "alt": {{ m.alt | default: current_product.title | json }},
        "srcset": "{{ m | image_url: width: 352 }} 352w, {{ m | image_url: width: 832 }} 832w, {{ m | image_url: width: 1000 }} 1000w"
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];

  window.PRODUCT_VARIANTS = [
    {%- for variant in current_product.variants -%}
      {
        "id": {{ variant.id }},
        "available": {{ variant.available | json }},
        "price": {{ variant.price | json }},
        "title": {{ variant.title | json }}
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];
</script>

<div class="product default-section">
  {%- if show_error -%}
    <div class="product_error">
      <h3>⚙️ {{ 'products.product.product_not_found' | t | default: 'Product not found' }}</h3>
      <p>{{ 'products.product.product_not_found_instruction' | t | default: 'Please select a product:' }}</p>
      <ol style="text-align: left; display: inline-block; margin-top: 12px;">
        <li>Open Theme Customizer</li>
        <li>Click on "Banner Product" section</li>
        <li>Select a product from the dropdown</li>
        <li>Click Save</li>
      </ol>
    </div>
  {%- else -%}
    <div class="product_content">
      <div class="product_gallery">
        <div class="swiper product-swiper-thumbs">
          <div class="swiper-wrapper"></div>
        </div>
        <div class="swiper product-swiper-main">
          {%- render 'product-badge', product: current_product -%}
          <div class="swiper-wrapper"></div>
        </div>
      </div>
      <div class="product_info">
        <div class="product_info__head">
          <h2 class="product_name">
            {{- current_product.title | escape | default: 'Product Title' -}}
          </h2>
          {%- if has_rating -%}
            {%- render 'product-rating', product: current_product -%}
          {%- endif -%}
          {%- unless current_product.description == blank -%}
            <div class="product_description">
              {{- current_product.description | strip_html -}}
            </div>
          {%- endunless -%}
          {%- if has_price -%}
            {%- render 'product-price-block', product: current_product -%}
          {%- endif -%}
        </div>
        {%- render 'product-color-selector', product: current_product -%}
        {%- render 'product-size-selector', product: current_product -%}
        {%- render 'product-add-to-cart-button', product: current_product -%}
        {%- if delivery_and_payment_tips != blank -%}
          <div class="product_tips">
            {%- for tip in delivery_and_payment_tips -%}
              {%- if tip.title != blank -%}
                <div class="product_tip">
                  {%- if tip.icon != blank -%}
                    <div class="product_tip__icon">
                      {{ tip.icon | image_url: width: 24 | image_tag }}
                    </div>
                  {%- endif -%}
                  <span class="product_tip__title">
                    {{ tip.title | escape }}
                  </span>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        {%- endif -%}
        {%- if product_secondary_description != blank -%}
          <p class="product_secondary_description">
            {{- product_secondary_description | strip_html -}}
          </p>
        {%- endif -%}
        {%- if product_accordion_items != blank -%}
          <div class="product_accordions">
            {%- for item in product_accordion_items -%}
              <div class="product_accordion">
                <details class="product_accordion__item">
                  <summary class="product_accordion__item__title">
                    <h3>{{ item.title }}</h3>
                    <span class="product_accordion__item__status"></span>
                  </summary>
                  <div class="product_accordion__item__content">
                    {{- item.content -}}
                  </div>
                </details>
              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>
    </div>
  {%- endif -%}
</div>

{% schema %}
{
  "name": "Banner Product",
  "tag": "section",
  "class": "section-banner-product",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "text",
      "id": "product_handle",
      "label": "Product Handle (fallback)",
      "info": "Used if product picker is not selected"
    }
  ],
  "presets": [
    {
      "name": "Banner Product"
    }
  ]
}
{% endschema %}
